DO $$ <<update_loop>>
BEGIN
	-- CREATE TEMPORARY TABLE
	CREATE TEMPORARY TABLE IF NOT EXISTS temp_compute_data (
		cart_id int,
		total_items int ,
		total_price int
	);
	
	CREATE TEMPORARY TABLE IF NOT EXISTS temp_to_process (
				cart_id int,
				total_items int,
				total_price int
	) ON COMMIT DELETE ROWS;

	
	WITH 
	 stats_items AS (
		 SELECT count(*) as total_items,cart_id
			FROM cart_items  
		 GROUP BY cart_id
	 ),
	  stats_Price AS (
		 SELECT SUM(price) as total_price,cart_id
			FROM cart_items  
		 GROUP BY cart_id
	 )
	 INSERT INTO temp_compute_data
	 SELECT p.cart_id, i.total_items, p.total_price FROM carts c
	 INNER JOIN stats_items i on c.id = i.cart_id
	 INNER JOIN stats_Price p on c.id = p.cart_id;

	-- Start loop 
	DECLARE rows_affected INTEGER DEFAULT 1;
	
	BEGIN
		WHILE rows_affected > 0 LOOP
			BEGIN
				with deleted as (
				DELETE FROM temp_compute_data
				RETURNING cart_id, total_items, total_price 
				LIMIT 5000
				)
				INSERT INTO temp_to_process 
				SELECT cart_id, total_items, total_price 
				FROM deleted;
				
				rows_affected = ROW_COUNT;
				
			COMMIT;
		END LOOP ;
	END;
END update_loop $$;